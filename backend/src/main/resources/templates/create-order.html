<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Place an Order</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Scrollable container for the article cards */
        .scrollable-cards {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container mt-4">
    <h1>Place Your Order</h1>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="filterCategory" class="form-label">Category</label>
            <select id="filterCategory" class="form-select">
                <option value="">All</option>
                <option th:each="cat : ${categories}"
                        th:value="${cat.id}"
                        th:text="${cat.name}">Category</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filterManufacturer" class="form-label">Manufacturer</label>
            <select id="filterManufacturer" class="form-select">
                <option value="">All</option>
                <option th:each="manu : ${manufacturers}"
                        th:value="${manu.id}"
                        th:text="${manu.name}">Manufacturer</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filterSearch" class="form-label">Article Name</label>
            <input type="text" id="filterSearch" class="form-control" placeholder="Search article">
        </div>
    </div>

    <!-- Articles Display as Cards in a Scrollable Container -->
    <div class="scrollable-cards row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="articleContainer">
        <div class="col" th:each="art : ${articles}"
             th:attr="data-category=${art.categoryId}, data-manufacturer=${art.manufacturerId}, data-article-name=${art.name}">
            <div class="card h-100">
                <!-- If you have an image, display it; otherwise, hide the image element -->
                <img th:src="@{${art.image}}" class="card-img-top" alt="Article Image" onerror="this.style.display='none'">
                <div class="card-body">
                    <h5 class="card-title" th:text="${art.name}">Article Name</h5>
                    <p class="card-text">
                        Price: $<span th:text="${art.price}">0.00</span><br>
                        In Stock: <span th:text="${art.price}">0</span>
                    </p>
                </div>
                <div class="card-footer">
                    <button type="button" class="btn btn-primary btn-sm add-article"
                            th:data-article-id="${art.id}"
                            th:data-article-name="${art.name}"
                            th:data-unit-price="${art.price}"
                            th:data-available="${art.price}">
                        Add to Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Summary Section -->
    <h3 class="mt-4">Order Summary</h3>
    <table class="table table-bordered" id="orderSummaryTable">
        <thead>
        <tr>
            <th>Article</th>
            <th>Unit Price</th>
            <th>Quantity</th>
            <th>Line Total</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody>
        <!-- Rows added dynamically -->
        </tbody>
    </table>
    <div class="mb-3">
        <label for="totalSum" class="form-label">Total Sum:</label>
        <span id="totalSum">0.00</span>
    </div>
    <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="proForma" name="proForma">
        <label class="form-check-label" for="proForma">Request Pro Forma</label>
    </div>

    <!-- Order Form: Hidden Field for Order Items (JSON) -->
    <form id="orderForm" th:action="@{/order/place}" method="post">
        <input type="hidden" id="orderItems" name="orderItems">
        <button type="submit" class="btn btn-success">Place Order</button>
    </form>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript for Filtering and Order Logic -->
<script>
    // An array to hold the order items
    const orderItems = [];

    // Function to update the order summary table and total sum
    function updateOrderSummary() {
        const tbody = document.querySelector('#orderSummaryTable tbody');
        tbody.innerHTML = ''; // Clear existing rows

        let totalSum = 0;
        orderItems.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${item.articleName}</td>
        <td>${item.unitPrice.toFixed(2)}</td>
        <td>${item.quantity}</td>
        <td>${(item.unitPrice * item.quantity).toFixed(2)}</td>
        <td><button type="button" class="btn btn-danger btn-sm" data-index="${index}">Remove</button></td>
      `;
            tbody.appendChild(row);
            totalSum += item.unitPrice * item.quantity;
        });
        document.getElementById('totalSum').textContent = totalSum.toFixed(2);
        document.getElementById('orderItems').value = JSON.stringify(orderItems);
    }

    // Event listener for Add to Order buttons on the article cards
    document.querySelectorAll('.add-article').forEach(function(button) {
        button.addEventListener('click', function() {
            const articleId = this.getAttribute('data-article-id');
            const articleName = this.getAttribute('data-article-name');
            const unitPrice = parseFloat(this.getAttribute('data-unit-price'));
            const available = parseInt(this.getAttribute('data-available'), 10);

            // For a better UX, you might use a modal or inline input for quantity.
            let quantity = prompt("Enter quantity for " + articleName, "1");
            quantity = parseInt(quantity, 10);
            if (isNaN(quantity) || quantity <= 0) {
                alert("Invalid quantity. Item not added.");
                return;
            }
            if (quantity > available) {
                alert("Quantity exceeds available stock.");
                return;
            }

            // Create an order item object
            const orderItem = {
                articleId: articleId,
                articleName: articleName,
                unitPrice: unitPrice,
                quantity: quantity
            };
            orderItems.push(orderItem);
            updateOrderSummary();
        });
    });

    // Delegate click event for Remove buttons in the order summary table
    document.getElementById('orderSummaryTable').addEventListener('click', function(event) {
        if (event.target.matches('button')) {
            const index = event.target.getAttribute('data-index');
            orderItems.splice(index, 1);
            updateOrderSummary();
        }
    });

    // Filtering Logic
    function filterArticles() {
        const categoryFilter = document.getElementById('filterCategory').value;
        const manufacturerFilter = document.getElementById('filterManufacturer').value;
        const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

        // Loop through each article card in the container
        document.querySelectorAll('#articleContainer > .col').forEach(function(card) {
            const cardCategory = card.getAttribute('data-category');
            const cardManufacturer = card.getAttribute('data-manufacturer');
            const cardArticleName = card.getAttribute('data-article-name').toLowerCase();

            let matches = true;
            if (categoryFilter && cardCategory !== categoryFilter) {
                matches = false;
            }
            if (manufacturerFilter && cardManufacturer !== manufacturerFilter) {
                matches = false;
            }
            if (searchFilter && !cardArticleName.includes(searchFilter)) {
                matches = false;
            }
            card.style.display = matches ? 'block' : 'none';
        });
    }

    // Attach event listeners to filter inputs
    document.getElementById('filterCategory').addEventListener('change', filterArticles);
    document.getElementById('filterManufacturer').addEventListener('change', filterArticles);
    document.getElementById('filterSearch').addEventListener('keyup', filterArticles);
</script>
</body>
</html>
