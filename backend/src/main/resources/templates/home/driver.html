<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Driver Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .scrollable-table {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container mt-4">
    <h1 th:text="'Here is your dashboard '+${user.getFirstName()}" class="mb-4"></h1>

    <div class="row">
        <div class="col-md-6">
            <h2>New Deliveries</h2>
            <div class="scrollable-table">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Delivery ID</th>
                        <th>Driver Name</th>
                        <th>Delivery Date</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="delivery : ${newDeliveries}">
                        <td th:text="${delivery.deliveryId}">1</td>
                        <td th:text="${delivery.driverName}">Driver Name</td>
                        <td th:text="${delivery.deliveryDate}">2025-02-14</td>
                        <td>
                            <button type="button"
                                    class="btn btn-primary btn-sm start-delivery-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#startDeliveryModal"
                                    th:attr="data-delivery-id=${delivery.deliveryId},
                                    data-driver-name=${delivery.driverName},
                                    data-delivery-date=${delivery.deliveryDate}">
                                Start Delivery
                            </button>

                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="col-md-12">
            <h2>Ongoing Deliveries</h2>
            <div class="scrollable-table">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Delivery ID</th>
                        <th>Driver Name</th>
                        <th>Delivery Date</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Assume ongoingDeliveries contains deliveries that have been started but not finished -->
                    <tr th:each="delivery : ${ongoingDeliveries}">
                        <td th:text="${delivery.deliveryId}">1</td>
                        <td th:text="${delivery.driverName}">Driver Name</td>
                        <td th:text="${delivery.deliveryDate}">2025-02-14</td>
                        <td>
                            <!-- End Delivery button opens the modal -->
                            <button type="button"
                                    class="btn btn-danger btn-sm end-delivery-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#endDeliveryModal"
                                    th:attr="data-delivery-id=${delivery.deliveryId}">
                                End Delivery
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="startDeliveryModal" tabindex="-1" aria-labelledby="startDeliveryModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/driver/start-delivery}" method="post" th:object="${startDelivery}">
                <div class="modal-header">
                    <h5 class="modal-title" id="startDeliveryModalLabel">Enter Delivery Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden input for the delivery ID -->
                    <input type="hidden" name="deliveryId" th:field="*{id}" id="modalDeliveryId"/>

                    <!-- Delivery Start Time (maps to delStartTime in DeliveryStartDto) -->
                    <div class="mb-3">
                        <label for="delStartTime" class="form-label">Start Time</label>
                        <input type="time" name="delStartTime" id="delStartTime" class="form-control" required>
                    </div>

                    <!-- Odometer Reading at Start (maps to delStartKm) -->
                    <div class="mb-3">
                        <label for="delStartKm" class="form-label">Odometer Start (Km)</label>
                        <input type="number" name="delStartKm" id="delStartKm" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <p id="modalDeliveryInfo"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Delivery</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="endDeliveryModal" tabindex="-1" aria-labelledby="endDeliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/driver/end-delivery}" method="post" th:object="${endDelivery}">
                <div class="modal-header">
                    <h5 class="modal-title" id="endDeliveryModalLabel">Finish Delivery</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden field for the delivery ID -->
                    <input type="hidden" th:field="*{id}" id="endDeliveryId" />

                    <!-- Odometer Reading at End -->
                    <div class="mb-3">
                        <label for="delEndKm" class="form-label">Odometer End (Km)</label>
                        <input type="number" th:field="*{delEndKm}" id="delEndKm" class="form-control" required>
                    </div>

                    <!-- Delivery End Time -->
                    <div class="mb-3">
                        <label for="delEndTime" class="form-label">End Time</label>
                        <input type="time" th:field="*{delEndTime}" id="delEndTime" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Finish Delivery</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.start-delivery-btn').forEach(function (button) {
        button.addEventListener('click', function () {
            const deliveryId = this.getAttribute('data-delivery-id');
            const driverName = this.getAttribute('data-driver-name');
            const deliveryDate = this.getAttribute('data-delivery-date');
            document.getElementById('modalDeliveryId').value = deliveryId;
            document.getElementById('modalDeliveryInfo').textContent =
                "Delivery Date: " + deliveryDate + " | Driver: " + driverName;
        });
    });
    document.querySelectorAll('.end-delivery-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            document.getElementById('endDeliveryId').value = this.getAttribute('data-delivery-id');
        });
    });
</script>
</body>
</html>